var b=e=>Math.max(0,Math.min(1,e)),M=e=>{e=b(e);let s,n,t;return e<.125?(s=0,n=0,t=.5+e*4):e<.375?(s=0,n=(e-.125)*4,t=1):e<.625?(s=(e-.375)*4,n=1,t=1-(e-.375)*4):e<.875?(s=1,n=1-(e-.625)*4,t=0):(s=1-(e-.875)*4,n=0,t=0),[Math.round(s*255),Math.round(n*255),Math.round(t*255)]},w=e=>{e=b(e);let s,n,t;return e<.33?(s=e*3,n=0,t=0):e<.67?(s=1,n=(e-.33)*3,t=0):(s=1,n=1,t=(e-.67)*3),[Math.round(s*255),Math.round(n*255),Math.round(t*255)]},C=(e,s)=>{s=b(s);let n=s*(e.length-1),t=Math.floor(n),c=Math.min(t+1,e.length-1),a=n-t;return[Math.round(e[t][0]+a*(e[c][0]-e[t][0])),Math.round(e[t][1]+a*(e[c][1]-e[t][1])),Math.round(e[t][2]+a*(e[c][2]-e[t][2]))]},T=e=>C([[68,1,84],[72,40,120],[62,74,137],[49,104,142],[38,130,142],[31,158,137],[53,183,121],[109,205,89],[180,222,44],[253,231,37]],e),F=e=>C([[13,8,135],[75,3,161],[125,3,168],[168,34,150],[203,70,121],[229,107,93],[248,148,65],[253,195,40],[240,249,33]],e),z=e=>{e=b(e);let s,n,t;return e<.375?(s=e*7/8,n=e*7/8,t=e*7/8+e/3):e<.75?(s=e*7/8,n=e*7/8+(e-.375)/3,t=.453125+(e-.375)*7/8):(s=.65625+(e-.75)/3+(e-.75)*7/8,n=.78125+(e-.75)*7/8,t=.78125+(e-.75)*7/8),[Math.round(Math.min(1,s)*255),Math.round(Math.min(1,n)*255),Math.round(Math.min(1,t)*255)]},A={jet:M,hot:w,viridis:T,plasma:F,bone:z};function E(e,s,n,t){let c=A[t]||M,a=new Uint8ClampedArray(s*n*4);for(let d=0;d<e.length;d++){let r=e[d]/255,[o,m,p]=c(r),l=d*4;a[l]=o,a[l+1]=m,a[l+2]=p,a[l+3]=255}return a}var i=e=>document.getElementById(e),$=[{canvasId:"noiseCanvas",resultId:"noiseResult",colormap:"jet",getResult:e=>e.noise,formatMetrics:e=>`Mean: ${e.metrics[0][1].toFixed(2)} | STD: ${e.metrics[1][1].toFixed(2)}`},{canvasId:"highpassCanvas",resultId:"highpassResult",colormap:"hot",getResult:e=>e.high_pass,formatMetrics:e=>`Mean: ${e.metrics[0][1].toFixed(2)} | STD: ${e.metrics[1][1].toFixed(2)}`},{canvasId:"elaCanvas",resultId:"elaResult",colormap:"hot",getResult:e=>e.ela,formatMetrics:e=>`Mean: ${e.metrics[0][1].toFixed(2)}`},{canvasId:"posterizeCanvas",resultId:"posterizeResult",colormap:"viridis",getResult:e=>e.posterize,formatMetrics:e=>`Mean: ${e.metrics[0][1].toFixed(2)}`},{canvasId:"channelCanvas",resultId:"channelResult",colormap:"plasma",getResult:e=>e.channels,formatMetrics:e=>`Mean: ${e.metrics[0][1].toFixed(2)} | STD: ${e.metrics[1][1].toFixed(2)}`},{canvasId:"fftCanvas",resultId:"fftResult",colormap:"bone",getResult:e=>e.fft,formatMetrics:e=>`Cross Score: ${e.metrics[0][1].toFixed(3)}`,size:e=>e.fft_size},{canvasId:"noisePatternsCanvas",resultId:"noisePatternsResult",colormap:"plasma",getResult:e=>e.noise_patterns,formatMetrics:e=>{let s=e.metrics.find(n=>n[0]==="directional_bias")?.[1]??0;return`Type: ${e.is_ai?"AI":"Brush"} | Dir: ${s.toFixed(3)}`}},{canvasId:"gradientsCanvas",resultId:"gradientsResult",colormap:"hot",getResult:e=>e.gradients,formatMetrics:e=>`Perfect: ${((e.metrics.find(n=>n[0]==="perfect_ratio")?.[1]??0)*100).toFixed(1)}% of gradients`},{canvasId:"clipCanvas",resultId:"clipResult",colormap:"viridis",getResult:e=>e.clip_space,formatMetrics:e=>`Coherence: ${((e.metrics.find(n=>n[0]==="coherence")?.[1]??0)*100).toFixed(1)}%`}],B=["Noise","High Pass","ELA","Banding","Channels","FFT Cross","Brush","Gradients","Style"];function R(e){return e>=.65?"detected":e>=.35?"uncertain":"clear"}var u=0,h=0,g=null,f=null,_=!1,y=null,L=null;function P(){return new Promise((e,s)=>{f=new Worker("/js/worker.js",{type:"module"});let n=setTimeout(()=>{s(new Error("Worker initialization timeout"))},1e4);f.onmessage=t=>{t.data.type==="ready"&&(clearTimeout(n),_=!0,e())},f.onerror=t=>{clearTimeout(n),s(t)}})}function I(e){if(!e.type.startsWith("image/")){alert("Please select an image file.");return}if(e.size>10*1024*1024){alert("Image too large. Max 10MB.");return}let s=new FileReader;s.onload=n=>{let t=new Image;t.onload=()=>S(t,e),t.src=n.target?.result},s.readAsDataURL(e)}function S(e,s){u=e.width,h=e.height;let n=i("originalCanvas");n.width=u,n.height=h,n.getContext("2d").drawImage(e,0,0,u,h);let c=(s.size/1024).toFixed(1);i("imageInfo").textContent=`${e.width}x${e.height} | ${s.type} | ${c} KB`,y=null,L=null,i("predictionPrompt").classList.remove("hidden"),i("analyzeBtn").classList.add("hidden"),document.querySelectorAll(".predict-btn").forEach(a=>a.classList.remove("selected")),i("upload-section").classList.add("hidden"),i("preview-section").classList.remove("hidden")}function v(e){i("loaderStep").textContent=e}async function j(){if(!f||!_){alert("Analyzer not ready. Please refresh the page.");return}i("preview-section").classList.add("hidden"),i("loading-section").classList.remove("hidden"),i("progressFill").style.width="0%",v("Preparing image...");let n=i("originalCanvas").getContext("2d").getImageData(0,0,u,h);return new Promise((t,c)=>{let a=setTimeout(()=>{c(new Error("Analysis timeout")),i("loading-section").classList.add("hidden"),i("preview-section").classList.remove("hidden"),alert("Analysis took too long. Try a smaller image.")},6e4);f.onmessage=r=>{let{type:o,step:m,result:p,error:l}=r.data;switch(o){case"progress":v(m),i("progressFill").style.width="50%";break;case"result":clearTimeout(a),i("progressFill").style.width="100%",v("Rendering..."),g=p,setTimeout(()=>{D(p),k(p),t()},50);break;case"error":clearTimeout(a),i("loading-section").classList.add("hidden"),i("preview-section").classList.remove("hidden"),alert(`Analysis failed: ${l}`),c(new Error(l));break}};let d=n.data.buffer.slice(0);f.postMessage({type:"analyze",data:d,width:u,height:h},[d])})}function D(e){i("loading-section").classList.add("hidden"),i("results-section").classList.remove("hidden"),document.querySelectorAll(".feedback-btn").forEach(t=>t.classList.remove("selected")),i("feedbackThanks").classList.add("hidden"),i("scoreValue").textContent=e.score.toString(),i("scoreCircle").className=`score-circle ${e.verdict_class}`,i("verdictText").textContent=e.verdict,i("confidenceText").textContent=`Confidence: ${e.confidence}`;let s=i("indicatorsList");s.innerHTML="";let n=[e.noise,e.high_pass,e.ela,e.posterize,e.channels,e.fft,e.noise_patterns,e.gradients,e.clip_space];B.forEach((t,c)=>{let a=n[c].ai_probability,d=Math.round(a*100),r=document.createElement("span");r.className=`indicator-tag ${R(a)}`,r.innerHTML=`${d}% ${t}`,s.appendChild(r)}),$.forEach(t=>{let c=i(t.canvasId),a=i(t.resultId),d=t.getResult(e),r=t.size?t.size(e):u,o=t.size?r:u,m=t.size?r:h,p=d.ai_probability,l=Math.round(p*100);H(c,d.data,o,m,t.colormap),a.textContent=`${l}% AI | ${t.formatMetrics(d)}`,a.className=`panel-result ${R(p)}`})}function H(e,s,n,t,c){e.width=n,e.height=t;let a=e.getContext("2d"),d=E(s,n,t,c),r=new ImageData(d,n,t);a.putImageData(r,0,0)}var O="https://script.google.com/macros/s/AKfycbwMJcZuj9hxCrGIKRqeZoE_ctpF4gtBpiqBXPhN3PvgbHqjFh1M3I1YohpGC7qXPFfbFQ/exec";function x(e,s=!1){let n={timestamp:new Date().toISOString(),dimensions:{width:u,height:h},score:e.score,verdict:e.verdict,confidence:e.confidence,methods:{noise:{ai_probability:e.noise.ai_probability,metrics:Object.fromEntries(e.noise.metrics)},high_pass:{ai_probability:e.high_pass.ai_probability,metrics:Object.fromEntries(e.high_pass.metrics)},ela:{ai_probability:e.ela.ai_probability,metrics:Object.fromEntries(e.ela.metrics)},posterize:{ai_probability:e.posterize.ai_probability,metrics:Object.fromEntries(e.posterize.metrics)},channels:{ai_probability:e.channels.ai_probability,metrics:Object.fromEntries(e.channels.metrics)},fft:{ai_probability:e.fft.ai_probability,metrics:Object.fromEntries(e.fft.metrics)},noise_patterns:{ai_probability:e.noise_patterns.ai_probability,metrics:Object.fromEntries(e.noise_patterns.metrics)},gradients:{ai_probability:e.gradients.ai_probability,metrics:Object.fromEntries(e.gradients.metrics)},clip_space:{ai_probability:e.clip_space.ai_probability,metrics:Object.fromEntries(e.clip_space.metrics)}}};return s&&(n.user_prediction=y,n.user_feedback=L),n}async function k(e,s=!1){try{let n=x(e,s);await fetch(O,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}catch(n){console.debug("Analytics send failed:",n)}}function q(){if(!g)return;let e=x(g),s=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(s),t=document.createElement("a");t.href=n,t.download=`ai-detector-results-${Date.now()}.json`,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(n)}function G(){i("results-section").classList.add("hidden"),i("preview-section").classList.add("hidden"),i("upload-section").classList.remove("hidden"),g=null,y=null,L=null;let e=i("imageInput");e.value="",document.querySelectorAll(".predict-btn, .feedback-btn").forEach(s=>s.classList.remove("selected")),i("feedbackThanks").classList.add("hidden")}async function N(){let e=i("imageInput"),s=i("selectBtn"),n=i("dropzone"),t=i("analyzeBtn"),c=i("resetBtn"),a=i("exportBtn"),d=()=>{e.click()};s.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),d()}),n.addEventListener("click",r=>{let o=r.target;o.id==="selectBtn"||o.closest("#selectBtn")||d()}),n.addEventListener("dragover",r=>{r.preventDefault(),n.classList.add("dragover")}),n.addEventListener("dragleave",()=>{n.classList.remove("dragover")}),n.addEventListener("drop",r=>{r.preventDefault(),n.classList.remove("dragover");let o=r.dataTransfer?.files;o&&o.length>0&&I(o[0])}),e.addEventListener("change",r=>{let o=r.target.files;o&&o.length>0&&I(o[0])}),t.addEventListener("click",j),c.addEventListener("click",G),a.addEventListener("click",q),document.querySelectorAll(".predict-btn").forEach(r=>{r.addEventListener("click",o=>{let m=o.target;y=m.dataset.prediction,document.querySelectorAll(".predict-btn").forEach(l=>l.classList.remove("selected")),m.classList.add("selected"),i("analyzeBtn").classList.remove("hidden")})}),document.querySelectorAll(".feedback-btn").forEach(r=>{r.addEventListener("click",o=>{let m=o.target;L=m.dataset.feedback,document.querySelectorAll(".feedback-btn").forEach(l=>l.classList.remove("selected")),m.classList.add("selected"),i("feedbackThanks").classList.remove("hidden"),g&&k(g,!0)})});try{await P()}catch(r){console.error("Failed to initialize worker:",r),alert("Failed to initialize analyzer. Please refresh the page.")}}document.addEventListener("DOMContentLoaded",N);
