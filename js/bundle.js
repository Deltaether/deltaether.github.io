var f=e=>Math.max(0,Math.min(1,e)),M=e=>{e=f(e);let s,n,t;return e<.125?(s=0,n=0,t=.5+e*4):e<.375?(s=0,n=(e-.125)*4,t=1):e<.625?(s=(e-.375)*4,n=1,t=1-(e-.375)*4):e<.875?(s=1,n=1-(e-.625)*4,t=0):(s=1-(e-.875)*4,n=0,t=0),[Math.round(s*255),Math.round(n*255),Math.round(t*255)]},_=e=>{e=f(e);let s,n,t;return e<.33?(s=e*3,n=0,t=0):e<.67?(s=1,n=(e-.33)*3,t=0):(s=1,n=1,t=(e-.67)*3),[Math.round(s*255),Math.round(n*255),Math.round(t*255)]},C=(e,s)=>{s=f(s);let n=s*(e.length-1),t=Math.floor(n),a=Math.min(t+1,e.length-1),o=n-t;return[Math.round(e[t][0]+o*(e[a][0]-e[t][0])),Math.round(e[t][1]+o*(e[a][1]-e[t][1])),Math.round(e[t][2]+o*(e[a][2]-e[t][2]))]},E=e=>C([[68,1,84],[72,40,120],[62,74,137],[49,104,142],[38,130,142],[31,158,137],[53,183,121],[109,205,89],[180,222,44],[253,231,37]],e),w=e=>C([[13,8,135],[75,3,161],[125,3,168],[168,34,150],[203,70,121],[229,107,93],[248,148,65],[253,195,40],[240,249,33]],e),F=e=>{e=f(e);let s,n,t;return e<.375?(s=e*7/8,n=e*7/8,t=e*7/8+e/3):e<.75?(s=e*7/8,n=e*7/8+(e-.375)/3,t=.453125+(e-.375)*7/8):(s=.65625+(e-.75)/3+(e-.75)*7/8,n=.78125+(e-.75)*7/8,t=.78125+(e-.75)*7/8),[Math.round(Math.min(1,s)*255),Math.round(Math.min(1,n)*255),Math.round(Math.min(1,t)*255)]},T={jet:M,hot:_,viridis:E,plasma:w,bone:F};function v(e,s,n,t){let a=T[t]||M,o=new Uint8ClampedArray(s*n*4);for(let c=0;c<e.length;c++){let r=e[c]/255,[d,u,m]=a(r),l=c*4;o[l]=d,o[l+1]=u,o[l+2]=m,o[l+3]=255}return o}var i=e=>document.getElementById(e),z=[{canvasId:"noiseCanvas",resultId:"noiseResult",colormap:"jet",getResult:e=>e.noise,formatMetrics:e=>`Mean: ${e.metrics[0][1].toFixed(2)} | STD: ${e.metrics[1][1].toFixed(2)}`},{canvasId:"highpassCanvas",resultId:"highpassResult",colormap:"hot",getResult:e=>e.high_pass,formatMetrics:e=>`Mean: ${e.metrics[0][1].toFixed(2)} | STD: ${e.metrics[1][1].toFixed(2)}`},{canvasId:"elaCanvas",resultId:"elaResult",colormap:"hot",getResult:e=>e.ela,formatMetrics:e=>`Mean: ${e.metrics[0][1].toFixed(2)}`},{canvasId:"posterizeCanvas",resultId:"posterizeResult",colormap:"viridis",getResult:e=>e.posterize,formatMetrics:e=>`Mean: ${e.metrics[0][1].toFixed(2)}`},{canvasId:"channelCanvas",resultId:"channelResult",colormap:"plasma",getResult:e=>e.channels,formatMetrics:e=>`Mean: ${e.metrics[0][1].toFixed(2)} | STD: ${e.metrics[1][1].toFixed(2)}`},{canvasId:"fftCanvas",resultId:"fftResult",colormap:"bone",getResult:e=>e.fft,formatMetrics:e=>`Cross Score: ${e.metrics[0][1].toFixed(3)}`,size:e=>e.fft_size},{canvasId:"noisePatternsCanvas",resultId:"noisePatternsResult",colormap:"plasma",getResult:e=>e.noise_patterns,formatMetrics:e=>{let s=e.metrics.find(n=>n[0]==="directional_bias")?.[1]??0;return`Type: ${e.is_ai?"AI":"Brush"} | Dir: ${s.toFixed(3)}`}},{canvasId:"gradientsCanvas",resultId:"gradientsResult",colormap:"hot",getResult:e=>e.gradients,formatMetrics:e=>`Perfect: ${((e.metrics.find(n=>n[0]==="perfect_ratio")?.[1]??0)*100).toFixed(1)}% of gradients`},{canvasId:"clipCanvas",resultId:"clipResult",colormap:"viridis",getResult:e=>e.clip_space,formatMetrics:e=>`Coherence: ${((e.metrics.find(n=>n[0]==="coherence")?.[1]??0)*100).toFixed(1)}%`}],$=["Noise","High Pass","ELA","Banding","Channels","FFT Cross","Brush","Gradients","Style"];function R(e){return e>=.65?"detected":e>=.35?"uncertain":"clear"}var p=0,h=0,b=null,g=null,I=!1;function B(){return new Promise((e,s)=>{g=new Worker("/js/worker.js",{type:"module"});let n=setTimeout(()=>{s(new Error("Worker initialization timeout"))},1e4);g.onmessage=t=>{t.data.type==="ready"&&(clearTimeout(n),I=!0,e())},g.onerror=t=>{clearTimeout(n),s(t)}})}function L(e){if(!e.type.startsWith("image/")){alert("Please select an image file.");return}if(e.size>10*1024*1024){alert("Image too large. Max 10MB.");return}let s=new FileReader;s.onload=n=>{let t=new Image;t.onload=()=>P(t,e),t.src=n.target?.result},s.readAsDataURL(e)}function P(e,s){p=e.width,h=e.height;let n=i("originalCanvas");n.width=p,n.height=h,n.getContext("2d").drawImage(e,0,0,p,h);let a=(s.size/1024).toFixed(1);i("imageInfo").textContent=`${e.width}x${e.height} | ${s.type} | ${a} KB`,i("upload-section").classList.add("hidden"),i("preview-section").classList.remove("hidden")}function y(e){i("loaderStep").textContent=e}async function A(){if(!g||!I){alert("Analyzer not ready. Please refresh the page.");return}i("preview-section").classList.add("hidden"),i("loading-section").classList.remove("hidden"),i("progressFill").style.width="0%",y("Preparing image...");let n=i("originalCanvas").getContext("2d").getImageData(0,0,p,h);return new Promise((t,a)=>{let o=setTimeout(()=>{a(new Error("Analysis timeout")),i("loading-section").classList.add("hidden"),i("preview-section").classList.remove("hidden"),alert("Analysis took too long. Try a smaller image.")},6e4);g.onmessage=r=>{let{type:d,step:u,result:m,error:l}=r.data;switch(d){case"progress":y(u),i("progressFill").style.width="50%";break;case"result":clearTimeout(o),i("progressFill").style.width="100%",y("Rendering..."),b=m,setTimeout(()=>{k(m),O(m),t()},50);break;case"error":clearTimeout(o),i("loading-section").classList.add("hidden"),i("preview-section").classList.remove("hidden"),alert(`Analysis failed: ${l}`),a(new Error(l));break}};let c=n.data.buffer.slice(0);g.postMessage({type:"analyze",data:c,width:p,height:h},[c])})}function k(e){i("loading-section").classList.add("hidden"),i("results-section").classList.remove("hidden"),i("scoreValue").textContent=e.score.toString(),i("scoreCircle").className=`score-circle ${e.verdict_class}`,i("verdictText").textContent=e.verdict,i("confidenceText").textContent=`Confidence: ${e.confidence}`;let s=i("indicatorsList");s.innerHTML="";let n=[e.noise,e.high_pass,e.ela,e.posterize,e.channels,e.fft,e.noise_patterns,e.gradients,e.clip_space];$.forEach((t,a)=>{let o=n[a].ai_probability,c=Math.round(o*100),r=document.createElement("span");r.className=`indicator-tag ${R(o)}`,r.innerHTML=`${c}% ${t}`,s.appendChild(r)}),z.forEach(t=>{let a=i(t.canvasId),o=i(t.resultId),c=t.getResult(e),r=t.size?t.size(e):p,d=t.size?r:p,u=t.size?r:h,m=c.ai_probability,l=Math.round(m*100);j(a,c.data,d,u,t.colormap),o.textContent=`${l}% AI | ${t.formatMetrics(c)}`,o.className=`panel-result ${R(m)}`})}function j(e,s,n,t,a){e.width=n,e.height=t;let o=e.getContext("2d"),c=v(s,n,t,a),r=new ImageData(c,n,t);o.putImageData(r,0,0)}var D="https://script.google.com/macros/s/AKfycbwMJcZuj9hxCrGIKRqeZoE_ctpF4gtBpiqBXPhN3PvgbHqjFh1M3I1YohpGC7qXPFfbFQ/exec";function x(e){return{timestamp:new Date().toISOString(),dimensions:{width:p,height:h},score:e.score,verdict:e.verdict,confidence:e.confidence,methods:{noise:{ai_probability:e.noise.ai_probability,metrics:Object.fromEntries(e.noise.metrics)},high_pass:{ai_probability:e.high_pass.ai_probability,metrics:Object.fromEntries(e.high_pass.metrics)},ela:{ai_probability:e.ela.ai_probability,metrics:Object.fromEntries(e.ela.metrics)},posterize:{ai_probability:e.posterize.ai_probability,metrics:Object.fromEntries(e.posterize.metrics)},channels:{ai_probability:e.channels.ai_probability,metrics:Object.fromEntries(e.channels.metrics)},fft:{ai_probability:e.fft.ai_probability,metrics:Object.fromEntries(e.fft.metrics)},noise_patterns:{ai_probability:e.noise_patterns.ai_probability,metrics:Object.fromEntries(e.noise_patterns.metrics)},gradients:{ai_probability:e.gradients.ai_probability,metrics:Object.fromEntries(e.gradients.metrics)},clip_space:{ai_probability:e.clip_space.ai_probability,metrics:Object.fromEntries(e.clip_space.metrics)}}}}async function O(e){try{let s=x(e);await fetch(D,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})}catch(s){console.debug("Analytics send failed:",s)}}function H(){if(!b)return;let e=x(b),s=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(s),t=document.createElement("a");t.href=n,t.download=`ai-detector-results-${Date.now()}.json`,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(n)}function S(){i("results-section").classList.add("hidden"),i("preview-section").classList.add("hidden"),i("upload-section").classList.remove("hidden"),b=null;let e=i("imageInput");e.value=""}async function G(){let e=i("imageInput"),s=i("selectBtn"),n=i("dropzone"),t=i("analyzeBtn"),a=i("resetBtn"),o=i("exportBtn"),c=()=>{e.click()};s.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),c()}),n.addEventListener("click",r=>{let d=r.target;d.id==="selectBtn"||d.closest("#selectBtn")||c()}),n.addEventListener("dragover",r=>{r.preventDefault(),n.classList.add("dragover")}),n.addEventListener("dragleave",()=>{n.classList.remove("dragover")}),n.addEventListener("drop",r=>{r.preventDefault(),n.classList.remove("dragover");let d=r.dataTransfer?.files;d&&d.length>0&&L(d[0])}),e.addEventListener("change",r=>{let d=r.target.files;d&&d.length>0&&L(d[0])}),t.addEventListener("click",A),a.addEventListener("click",S),o.addEventListener("click",H);try{await B()}catch(r){console.error("Failed to initialize worker:",r),alert("Failed to initialize analyzer. Please refresh the page.")}}document.addEventListener("DOMContentLoaded",G);
